/*<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</h2>
    <button id="signButton">ç½²åã™ã‚‹</button>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("ğŸ“Œ signMessage() ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");

            if (!window.ethereum) {
                alert("Metamaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼");
                console.log("âŒ MetamaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const nonce = urlParams.get('nonce');

            console.log("âœ… å–å¾—ã—ãŸURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:", { userId, nonce });

            if (!userId || !nonce) {
                alert("èªè¨¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ");
                console.log("âŒ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
                return;
            }

            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("âœ… Metamaskã®æ¥ç¶šã«æˆåŠŸ");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:", address);

                const decodedNonce = decodeURIComponent(nonce);
                console.log("âœ… ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®nonce:", decodedNonce);

                const signature = await signer.signMessage(decodedNonce);
                console.log("âœ… ç½²åæˆåŠŸ:", signature);

                await fetch("https://web-gilt-nine.vercel.app/api/webhook", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, address, signature })
                });

                alert("èªè¨¼å®Œäº†ï¼Discordã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            } catch (error) {
                console.error("âŒ ç½²åã‚¨ãƒ©ãƒ¼:", error);
                alert("ç½²åã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>*/
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</h2>
    <button id="signButton">ç½²åã™ã‚‹</button>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("ğŸ“Œ signMessage() ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");

            if (!window.ethereum) {
                alert("Metamaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼");
                console.log("âŒ MetamaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const nonce = urlParams.get('nonce');

            console.log("âœ… å–å¾—ã—ãŸURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:", { userId, nonce });

            if (!userId || !nonce) {
                alert("èªè¨¼ã‚¨ãƒ©ãƒ¼: ä¸æ­£ãªãƒªã‚¯ã‚¨ã‚¹ãƒˆ");
                console.log("âŒ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¦ã„ã¾ã›ã‚“");
                return;
            }

            try {
                // ğŸ”¹ nonce ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦ä¿å­˜
                console.log("ğŸ”¹ nonce ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ä¸­...");
                const verifyResponse = await fetch("https://web-gilt-nine.vercel.app/api/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, nonce })
                });

                if (!verifyResponse.ok) {
                    console.error("âŒ nonce ã®ä¿å­˜ã«å¤±æ•—:", await verifyResponse.text());
                    alert("èªè¨¼ã‚¨ãƒ©ãƒ¼: nonce ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    return;
                }

                console.log("âœ… nonce ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜æˆåŠŸ");

                // ğŸ”¹ Metamask ã§ç½²åå‡¦ç†
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("âœ… Metamaskã®æ¥ç¶šã«æˆåŠŸ");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:", address);

                const decodedNonce = decodeURIComponent(nonce);
                console.log("âœ… ãƒ‡ã‚³ãƒ¼ãƒ‰å¾Œã®nonce:", decodedNonce);

                const signature = await signer.signMessage(decodedNonce);
                console.log("âœ… ç½²åæˆåŠŸ:", signature);

                // ğŸ”¹ ç½²åã‚’ `/api/webhook` ã«é€ä¿¡
                await fetch("https://web-gilt-nine.vercel.app/api/webhook", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, address, signature })
                });

                alert("èªè¨¼å®Œäº†ï¼Discordã‚’ç¢ºèªã—ã¦ãã ã•ã„");
            } catch (error) {
                console.error("âŒ ç½²åã‚¨ãƒ©ãƒ¼:", error);
                alert("ç½²åã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
        }
    </script>
</body>
</html>
