<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウォレット認証</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskでウォレット認証</h2>
    <button id="signButton">署名する</button>
    <p id="result"></p>

    <script>
        const RPC_URL = "https://testnet-rpc.monad.xyz/";
        const NFT_CONTRACT = "0x38477a51e2a69e831512d4b36410b0689d8c5e2b";

        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("📌 signMessage() が実行されました");

            if (!window.ethereum) {
                alert("Metamaskをインストールしてください！");
                console.log("❌ Metamaskが見つかりません");
                return;
            }

            try {
                // Metamask接続
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("✅ Metamaskの接続に成功");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("✅ ウォレットアドレス:", address);

                // NFT所有確認
                const hasNFT = await checkNFTOwnership(address);
                if (hasNFT) {
                    document.getElementById("result").textContent = "✅ NFT所有確認済み！";
                    console.log("✅ NFT所有確認成功");
                } else {
                    document.getElementById("result").textContent = "❌ NFTを所有していません。";
                    console.log("❌ NFT所有なし");
                }
            } catch (error) {
                console.error("❌ 認証エラー:", error);
                alert("認証に失敗しました。");
            }
        }

        async function checkNFTOwnership(userAddress) {
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const abi = [
        "function balanceOf(address owner) view returns (uint256)", // ERC-721用
        "function balanceOf(address owner, uint256 id) view returns (uint256)", // ERC-1155用
        "function ownerOf(uint256 tokenId) view returns (address)" // ERC-721のowner取得用
    ];
    
    const contract = new ethers.Contract(NFT_CONTRACT, abi, provider);

    try {
        // まずERC-721としてチェック
        try {
            const owner = await contract.ownerOf(1); // `tokenId = 1` で確認
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
                console.log("✅ ERC-721 NFTを所有しています");
                return true;
            }
        } catch (e) {
            console.log("⚠ ERC-721の `ownerOf` でエラー。ERC-1155を試します...");
        }

        // 次にERC-1155としてチェック
        try {
            const balance = await contract.balanceOf(userAddress, 1); // `tokenId = 1`
            console.log("NFT保有数:", balance.toString());
            return balance.gt(0);
        } catch (e) {
            console.log("⚠ ERC-1155の `balanceOf` でエラー");
        }

        console.log("❌ NFT所有なし");
        return false;
    } catch (error) {
        console.error("❌ NFT確認エラー:", error);
        return false;
    }
}

    </script>
</body>
</html>
