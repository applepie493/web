<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウォレット認証</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskでウォレット認証</h2>
    <button id="signButton">署名する</button>
    <p id="result"></p>

    <script>
        const BLOCKVISION_API = "https://monad-testnet.blockvision.org/v1/2tsYBqY0lhEI3iyF61cRxqKCaS3";
        const NFT_CONTRACT = "0x38477a51e2a69e831512d4b36410b0689d8c5e2b";

        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("📌 signMessage() が実行されました");

            if (!window.ethereum) {
                alert("Metamaskをインストールしてください！");
                console.log("❌ Metamaskが見つかりません");
                return;
            }

            try {
                // Metamask接続
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("✅ Metamaskの接続に成功");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("✅ ウォレットアドレス:", address);

                // NFT所有確認（BlockVision API）
                const hasNFT = await checkNFTOwnership(address);
                if (hasNFT) {
                    document.getElementById("result").textContent = "✅ NFT所有確認済み！（BlockVision API）";
                    console.log("✅ NFT所有確認成功");
                } else {
                    document.getElementById("result").textContent = "❌ NFTを所有していません。（BlockVision API）";
                    console.log("❌ NFT所有なし");
                }
            } catch (error) {
                console.error("❌ 認証エラー:", error);
                alert("認証に失敗しました。");
            }
        }

    async function checkNFTOwnership(userAddress) {
        const BLOCKVISION_API = "https://monad-testnet.blockvision.org/v1/2tsYBqY0lhEI3iyF61cRxqKCaS3";
        
        try {
            const response = await fetch(`${BLOCKVISION_API}/tokens?owner=${userAddress}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
                redirect: "follow"
            });
    
            if (!response.ok) {
                console.error("❌ BlockVision API 404 エラー:", response.statusText);
                return false;
            }
    
            const data = await response.json();
            console.log("📌 取得したNFT情報:", data);
    
            const tokens = data.result || [];
            const hasNFT = tokens.some(token => token.contract_address.toLowerCase() === NFT_CONTRACT.toLowerCase());
            return hasNFT;
        } catch (error) {
            console.error("❌ BlockVision API エラー:", error);
            return false;
        }
    }

    </script>
</body>
</html>
