/*<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウォレット認証</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskでウォレット認証</h2>
    <button id="signButton">署名する</button>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("📌 signMessage() が実行されました");

            if (!window.ethereum) {
                alert("Metamaskをインストールしてください！");
                console.log("❌ Metamaskが見つかりません");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const nonce = urlParams.get('nonce');

            console.log("✅ 取得したURLパラメータ:", { userId, nonce });

            if (!userId || !nonce) {
                alert("認証エラー: 不正なリクエスト");
                console.log("❌ URLパラメータが取得できていません");
                return;
            }

            try {
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("✅ Metamaskの接続に成功");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("✅ ウォレットアドレス:", address);

                const decodedNonce = decodeURIComponent(nonce);
                console.log("✅ デコード後のnonce:", decodedNonce);

                const signature = await signer.signMessage(decodedNonce);
                console.log("✅ 署名成功:", signature);

                await fetch("https://web-gilt-nine.vercel.app/api/webhook", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, address, signature })
                });

                alert("認証完了！Discordを確認してください");
            } catch (error) {
                console.error("❌ 署名エラー:", error);
                alert("署名に失敗しました。詳細はコンソールを確認してください。");
            }
        }
    </script>
</body>
</html>*/
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウォレット認証</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskでウォレット認証</h2>
    <button id="signButton">署名する</button>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("📌 signMessage() が実行されました");

            if (!window.ethereum) {
                alert("Metamaskをインストールしてください！");
                console.log("❌ Metamaskが見つかりません");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const nonce = urlParams.get('nonce');

            console.log("✅ 取得したURLパラメータ:", { userId, nonce });

            if (!userId || !nonce) {
                alert("認証エラー: 不正なリクエスト");
                console.log("❌ URLパラメータが取得できていません");
                return;
            }

            try {
                // 🔹 nonce をサーバーに送信して保存
                console.log("🔹 nonce をサーバーに送信中...");
                const verifyResponse = await fetch("https://web-gilt-nine.vercel.app/api/verify", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, nonce })
                });

                if (!verifyResponse.ok) {
                    console.error("❌ nonce の保存に失敗:", await verifyResponse.text());
                    alert("認証エラー: nonce の保存に失敗しました");
                    return;
                }

                console.log("✅ nonce をサーバーに保存成功");

                // 🔹 Metamask で署名処理
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("✅ Metamaskの接続に成功");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("✅ ウォレットアドレス:", address);

                const decodedNonce = decodeURIComponent(nonce);
                console.log("✅ デコード後のnonce:", decodedNonce);

                const signature = await signer.signMessage(decodedNonce);
                console.log("✅ 署名成功:", signature);

                // 🔹 署名を `/api/webhook` に送信
                await fetch("https://web-gilt-nine.vercel.app/api/webhook", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ userId, address, signature })
                });

                alert("認証完了！Discordを確認してください");
            } catch (error) {
                console.error("❌ 署名エラー:", error);
                alert("署名に失敗しました。詳細はコンソールを確認してください。");
            }
        }
    </script>
</body>
</html>
