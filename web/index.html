<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</h2>
    <button id="signButton">ç½²åã™ã‚‹</button>
    <p id="result"></p>

    <script>
        const RPC_URL = "https://testnet-rpc.monad.xyz/";
        const NFT_CONTRACT = "0x38477a51e2a69e831512d4b36410b0689d8c5e2b";

        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("ğŸ“Œ signMessage() ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");

            if (!window.ethereum) {
                alert("Metamaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼");
                console.log("âŒ MetamaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            try {
                // Metamaskæ¥ç¶š
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("âœ… Metamaskã®æ¥ç¶šã«æˆåŠŸ");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:", address);

                // NFTæ‰€æœ‰ç¢ºèª
                const hasNFT = await checkNFTOwnership(address);
                if (hasNFT) {
                    document.getElementById("result").textContent = "âœ… NFTæ‰€æœ‰ç¢ºèªæ¸ˆã¿ï¼";
                    console.log("âœ… NFTæ‰€æœ‰ç¢ºèªæˆåŠŸ");
                } else {
                    document.getElementById("result").textContent = "âŒ NFTã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã›ã‚“ã€‚";
                    console.log("âŒ NFTæ‰€æœ‰ãªã—");
                }
            } catch (error) {
                console.error("âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        async function checkNFTOwnership(userAddress) {
    const provider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const abi = [
        "function balanceOf(address owner) view returns (uint256)", // ERC-721ç”¨
        "function balanceOf(address owner, uint256 id) view returns (uint256)", // ERC-1155ç”¨
        "function ownerOf(uint256 tokenId) view returns (address)" // ERC-721ã®ownerå–å¾—ç”¨
    ];
    
    const contract = new ethers.Contract(NFT_CONTRACT, abi, provider);

    try {
        // ã¾ãšERC-721ã¨ã—ã¦ãƒã‚§ãƒƒã‚¯
        try {
            const owner = await contract.ownerOf(1); // `tokenId = 1` ã§ç¢ºèª
            if (owner.toLowerCase() === userAddress.toLowerCase()) {
                console.log("âœ… ERC-721 NFTã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã™");
                return true;
            }
        } catch (e) {
            console.log("âš  ERC-721ã® `ownerOf` ã§ã‚¨ãƒ©ãƒ¼ã€‚ERC-1155ã‚’è©¦ã—ã¾ã™...");
        }

        // æ¬¡ã«ERC-1155ã¨ã—ã¦ãƒã‚§ãƒƒã‚¯
        try {
            const balance = await contract.balanceOf(userAddress, 1); // `tokenId = 1`
            console.log("NFTä¿æœ‰æ•°:", balance.toString());
            return balance.gt(0);
        } catch (e) {
            console.log("âš  ERC-1155ã® `balanceOf` ã§ã‚¨ãƒ©ãƒ¼");
        }

        console.log("âŒ NFTæ‰€æœ‰ãªã—");
        return false;
    } catch (error) {
        console.error("âŒ NFTç¢ºèªã‚¨ãƒ©ãƒ¼:", error);
        return false;
    }
}

    </script>
</body>
</html>
