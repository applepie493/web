<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</h2>
    <button id="signButton">ç½²åã™ã‚‹</button>
    <p id="result"></p>

    <script>
        const BLOCKVISION_API = "https://monad-testnet.blockvision.org/v1/2tsYBqY0lhEI3iyF61cRxqKCaS3";
        const NFT_CONTRACT = "0x38477a51e2a69e831512d4b36410b0689d8c5e2b";

        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("ğŸ“Œ signMessage() ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");

            if (!window.ethereum) {
                alert("Metamaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼");
                console.log("âŒ MetamaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            try {
                // Metamaskæ¥ç¶š
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("âœ… Metamaskã®æ¥ç¶šã«æˆåŠŸ");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:", address);

                // NFTæ‰€æœ‰ç¢ºèªï¼ˆBlockVision APIï¼‰
                const hasNFT = await checkNFTOwnership(address);
                if (hasNFT) {
                    document.getElementById("result").textContent = "âœ… NFTæ‰€æœ‰ç¢ºèªæ¸ˆã¿ï¼ï¼ˆBlockVision APIï¼‰";
                    console.log("âœ… NFTæ‰€æœ‰ç¢ºèªæˆåŠŸ");
                } else {
                    document.getElementById("result").textContent = "âŒ NFTã‚’æ‰€æœ‰ã—ã¦ã„ã¾ã›ã‚“ã€‚ï¼ˆBlockVision APIï¼‰";
                    console.log("âŒ NFTæ‰€æœ‰ãªã—");
                }
            } catch (error) {
                console.error("âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

    async function checkNFTOwnership(userAddress) {
        const BLOCKVISION_API = "https://monad-testnet.blockvision.org/v1/2tsYBqY0lhEI3iyF61cRxqKCaS3";
        
        try {
            const response = await fetch(`${BLOCKVISION_API}/tokens?owner=${userAddress}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json"
                },
                redirect: "follow"
            });
    
            if (!response.ok) {
                console.error("âŒ BlockVision API 404 ã‚¨ãƒ©ãƒ¼:", response.statusText);
                return false;
            }
    
            const data = await response.json();
            console.log("ğŸ“Œ å–å¾—ã—ãŸNFTæƒ…å ±:", data);
    
            const tokens = data.result || [];
            const hasNFT = tokens.some(token => token.contract_address.toLowerCase() === NFT_CONTRACT.toLowerCase());
            return hasNFT;
        } catch (error) {
            console.error("âŒ BlockVision API ã‚¨ãƒ©ãƒ¼:", error);
            return false;
        }
    }

    </script>
</body>
</html>
