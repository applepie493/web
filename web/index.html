<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆèªè¨¼</h2>
    <button id="signButton">ç½²åã™ã‚‹</button>
    <p id="result"></p>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("ğŸ“Œ signMessage() ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ");

            if (!window.ethereum) {
                alert("Metamaskã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ï¼");
                console.log("âŒ MetamaskãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                return;
            }

            try {
                // Metamaskæ¥ç¶š
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("âœ… Metamaskã®æ¥ç¶šã«æˆåŠŸ");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹:", address);

                // output.txt ã‚’èª­ã¿è¾¼ã‚“ã§ãƒã‚§ãƒƒã‚¯
                const isInList = await checkWalletInList(address);
                if (isInList) {
                    document.getElementById("result").textContent = "âœ… è©²å½“ï¼";
                    console.log("âœ… ã‚¦ã‚©ãƒ¬ãƒƒãƒˆãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™");
                } else {
                    document.getElementById("result").textContent = "âŒ è©²å½“ãªã—";
                    console.log("âŒ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
                }
            } catch (error) {
                console.error("âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:", error);
                alert("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            }
        }

        async function checkWalletInList(userAddress) {
            try {
                const response = await fetch("./output.txt"); // âœ… ãƒ‘ã‚¹ã‚’ä¿®æ­£
                if (!response.ok) throw new Error("ãƒªã‚¹ãƒˆã®å–å¾—ã«å¤±æ•—");

                const text = await response.text();
                console.log("ğŸ“œ èª­ã¿è¾¼ã‚“ã ãƒªã‚¹ãƒˆ:", text); // âœ… å–å¾—ã—ãŸå†…å®¹ã‚’ãƒ­ã‚°ã«è¡¨ç¤º
                const walletList = text.split("\n").map(line => line.trim()).filter(line => line.startsWith("0x"));

                // çŸ­ç¸®è¡¨è¨˜ã«å¤‰æ›
                const formattedUserAddress = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);

                console.log("ğŸ” ç¢ºèªä¸­ã®ã‚¦ã‚©ãƒ¬ãƒƒãƒˆ:", formattedUserAddress);
                console.log("ğŸ“œ ã‚¦ã‚©ãƒ¬ãƒƒãƒˆãƒªã‚¹ãƒˆ:", walletList);

                return walletList.includes(formattedUserAddress);
            } catch (error) {
                console.error("âŒ ãƒªã‚¹ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:", error);
                return false;
            }
        }
    </script>
</body>
</html>
