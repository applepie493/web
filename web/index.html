<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ウォレット認証</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
</head>
<body>
    <h2>Metamaskでウォレット認証</h2>
    <button id="signButton">署名する</button>
    <p id="result"></p>

    <script>
        window.onload = function () {
            document.getElementById("signButton").addEventListener("click", signMessage);
        };

        async function signMessage() {
            console.log("📌 signMessage() が実行されました");

            if (!window.ethereum) {
                alert("Metamaskをインストールしてください！");
                console.log("❌ Metamaskが見つかりません");
                return;
            }

            try {
                // Metamask接続
                const provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                console.log("✅ Metamaskの接続に成功");

                const signer = provider.getSigner();
                const address = await signer.getAddress();
                console.log("✅ ウォレットアドレス:", address);

                // output.txt を読み込んでチェック
                const isInList = await checkWalletInList(address);
                if (isInList) {
                    document.getElementById("result").textContent = "✅ 該当！";
                    console.log("✅ ウォレットリストに含まれています");
                } else {
                    document.getElementById("result").textContent = "❌ 該当なし";
                    console.log("❌ ウォレットリストに含まれていません");
                }
            } catch (error) {
                console.error("❌ 認証エラー:", error);
                alert("認証に失敗しました。");
            }
        }

        async function checkWalletInList(userAddress) {
            try {
                const response = await fetch("./output.txt"); // ✅ パスを修正
                if (!response.ok) throw new Error("リストの取得に失敗");

                const text = await response.text();
                console.log("📜 読み込んだリスト:", text); // ✅ 取得した内容をログに表示
                const walletList = text.split("\n").map(line => line.trim()).filter(line => line.startsWith("0x"));

                // 短縮表記に変換
                const formattedUserAddress = userAddress.slice(0, 6) + "..." + userAddress.slice(-4);

                console.log("🔍 確認中のウォレット:", formattedUserAddress);
                console.log("📜 ウォレットリスト:", walletList);

                return walletList.includes(formattedUserAddress);
            } catch (error) {
                console.error("❌ リストチェックエラー:", error);
                return false;
            }
        }
    </script>
</body>
</html>
